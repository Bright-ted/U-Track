{% extends "base.html" %}

{% block content %}
<div class="course-sessions-container">
    <!-- Course Header -->
    <div class="course-header">
        <div class="course-info">
            <h2><i class="fas fa-calendar-alt"></i> Sessions - {{ course.course_code }}</h2>
            <p class="course-subtitle">{{ course.course_title }} • {{ course.academic_year }} • Semester {{ course.semester }}</p>
        </div>
        <div class="course-actions">
            <a href="/lecturer/courses/{{ course.id }}/session-settings" class="btn btn-secondary">
                <i class="fas fa-cogs"></i> Session Settings
            </a>
            <a href="/lecturer/courses" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Back to Courses
            </a>
        </div>
    </div>

    <!-- Active Session Section -->
    {% if active_session %}
    <div class="active-session-card">
        <div class="session-header">
            <div class="session-status">
                <span class="badge badge-success"><i class="fas fa-circle"></i> ACTIVE SESSION</span>
                <span class="session-id">ID: {{ active_session.id[:8] }}...</span>
            </div>
            <div class="session-actions">
                <a href="/lecturer/courses/{{ course.id }}/live-attendance" class="btn btn-primary">
                    <i class="fas fa-tv"></i> Go to Live Attendance
                </a>
                <form method="POST" action="/lecturer/courses/{{ course.id }}/end-session" class="d-inline">
                    <button type="submit" class="btn btn-danger" onclick="return confirm('End this session? Attendance will be finalized.')">
                        <i class="fas fa-stop-circle"></i> End Session
                    </button>
                </form>
            </div>
        </div>

        <!-- Session Time Controls -->
        <div class="session-time-controls">
            <div class="time-info">
                <h4><i class="fas fa-clock"></i> Session Time</h4>
                <div class="time-display">
                    <div class="time-item">
                        <span class="time-label">Started:</span>
                        <span class="time-value" id="sessionStartTime">
                            {% if active_session.started_at %}
                                {{ active_session.started_at|datetimeformat('medium') }}
                            {% elif active_session.created_at %}
                                {{ active_session.created_at|datetimeformat('medium') }}
                            {% else %}
                                Just now
                            {% endif %}
                        </span>
                    </div>
                    <div class="time-item">
                        <span class="time-label">Status:</span>
                        <span class="badge badge-success">Active</span>
                    </div>
                </div>
                
                {% if active_session.time_remaining_formatted %}
                <div class="progress mt-3">
                    <div class="progress-bar" id="sessionProgressBar" role="progressbar" style="width: {{ active_session.session_progress|default(0) }}%"></div>
                </div>
                <div class="time-remaining" id="timeRemaining">
                    <i class="fas fa-hourglass-half"></i> Time remaining: {{ active_session.time_remaining_formatted }}
                </div>
                {% endif %}
            </div>
            
            <div class="session-stats">
                <div class="stat-item">
                    <i class="fas fa-users"></i>
                    <div class="stat-content">
                        <span class="stat-label">Attendance</span>
                        <span class="stat-value" id="attendanceCount">0</span>
                    </div>
                </div>
                <div class="stat-item">
                    <i class="fas fa-qrcode"></i>
                    <div class="stat-content">
                        <span class="stat-label">QR Code</span>
                        <span class="stat-value">Active</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
            <a href="/lecturer/courses/{{ course.id }}/qr" target="_blank" class="btn btn-outline-primary">
                <i class="fas fa-qrcode"></i> View QR Code
            </a>
            <button class="btn btn-outline-success" onclick="refreshQR()">
                <i class="fas fa-sync-alt"></i> Refresh QR
            </button>
            <form method="POST" action="/lecturer/courses/{{ course.id }}/extend-session" class="d-inline">
                <button type="submit" class="btn btn-outline-warning">
                    <i class="fas fa-plus-circle"></i> Extend 30 min
                </button>
            </form>
            <a href="/lecturer/courses/{{ course.id }}/attendance/manual" class="btn btn-outline-info">
                <i class="fas fa-edit"></i> Manual Attendance
            </a>
        </div>
    </div>
    {% else %}
    <!-- No Active Session -->
    <div class="no-session-card">
        <div class="no-session-content">
            <div class="no-session-icon"><i class="fas fa-calendar-plus fa-3x"></i></div>
            <h3>No Active Session</h3>
            <p class="text-muted">Start a new session to begin taking attendance.</p>
            <form method="POST" action="/lecturer/courses/{{ course.id }}/start-session">
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="fas fa-play-circle"></i> Start New Session
                </button>
            </form>
            <div class="session-tips mt-4">
                <p><strong>Tips:</strong></p>
                <ul>
                    <li>Sessions automatically expire after 3 hours (configurable)</li>
                    <li>QR codes refresh every 30 seconds for security</li>
                    <li>You can manually end sessions anytime</li>
                </ul>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Past Sessions Table -->
    <div class="sessions-history-card">
        <h3><i class="fas fa-history"></i> Session History</h3>
        
        {% if sessions %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Date & Time</th>
                        <th>Duration</th>
                        <th>Attendance</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for session in sessions %}
                    <tr>
                        <td>
                            <div class="session-time">
                                <div class="date">
                                    {% if session.session_date %}
                                        {{ session.session_date }}
                                    {% elif session.created_at %}
                                        {{ session.created_at|datetimeformat('date') }}
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </div>
                                <div class="time">
                                    {% if session.start_time %}
                                        {{ session.start_time }}
                                    {% elif session.created_at %}
                                        {{ session.created_at|datetimeformat('time') }}
                                    {% endif %}
                                </div>
                            </div>
                        </td>
                        <td>
                            {% if session.start_time and session.end_time %}
                                <span class="duration">{{ session.start_time }} - {{ session.end_time }}</span>
                            {% elif session.is_active %}
                                <span class="text-success">Ongoing</span>
                            {% else %}
                                <span class="text-muted">Unknown</span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="attendance-count">{{ session.id|get_attendance_count }}</span>
                        </td>
                        <td>
                            {% if session.is_active %}
                                <span class="badge badge-success">Active</span>
                            {% else %}
                                <span class="badge badge-secondary">Ended</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="session-actions-small">
                                <a href="/lecturer/courses/{{ course.id }}/attendance?session={{ session.id }}"
                                   class="btn btn-sm btn-outline-info" title="View Attendance">
                                    <i class="fas fa-list"></i>
                                </a>
                                {% if not session.is_active %}
                                <button class="btn btn-sm btn-outline-secondary" onclick="copySessionLink('{{ session.id }}')" title="Copy Session ID">
                                    <i class="fas fa-copy"></i>
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-history">
            <i class="fas fa-calendar-times fa-2x"></i>
            <p>No session history found for this course.</p>
        </div>
        {% endif %}
    </div>
</div>

<style>
    /* Keep your existing CSS styles */
    .course-sessions-container { padding: 20px; max-width: 1200px; margin: 0 auto; }
    .course-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #eaeaea; }
    .course-info h2 { margin: 0; color: #333; display: flex; align-items: center; gap: 10px; }
    .course-subtitle { margin: 8px 0 0 0; color: #666; }
    .course-actions { display: flex; gap: 10px; }
    
    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 10px 20px; border-radius: 8px; font-weight: 500; text-decoration: none; border: none; cursor: pointer; transition: all 0.3s ease; }
    .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); color: white; }
    .btn-secondary { background: #6c757d; color: white; }
    .btn-secondary:hover { background: #545b62; color: white; }
    .btn-danger { background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%); color: white; }
    .btn-danger:hover { background: #dc3545; color: white; }
    
    .active-session-card { background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); margin-bottom: 30px; overflow: hidden; }
    .session-header { display: flex; justify-content: space-between; align-items: center; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    .badge-success { background: rgba(255,255,255,0.2); color: white; padding: 8px 16px; border-radius: 20px; font-weight: 500; display: inline-flex; align-items: center; gap: 8px; }
    .badge-success i { font-size: 0.8rem; animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .session-id { font-family: monospace; font-size: 0.9rem; opacity: 0.8; }
    .session-actions { display: flex; gap: 10px; }
    
    .session-time-controls { padding: 25px; display: grid; grid-template-columns: 2fr 1fr; gap: 30px; }
    .time-info h4 { margin: 0 0 20px 0; color: #333; display: flex; align-items: center; gap: 10px; }
    .time-display { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 20px; }
    .time-item { display: flex; flex-direction: column; }
    .time-label { font-size: 0.85rem; color: #666; margin-bottom: 5px; }
    .time-value { font-weight: 500; color: #333; font-size: 1.1rem; }
    .progress { height: 10px; background: #e9ecef; border-radius: 5px; overflow: hidden; margin: 15px 0 10px 0; }
    .progress-bar { background: linear-gradient(90deg, #42b883, #4CAF50); transition: width 1s linear; }
    .time-remaining { color: #666; font-size: 0.9rem; display: flex; align-items: center; gap: 8px; }
    
    .session-stats { display: flex; flex-direction: column; gap: 20px; }
    .stat-item { display: flex; align-items: center; gap: 15px; padding: 20px; background: #f8f9fa; border-radius: 10px; }
    .stat-item i { font-size: 1.5rem; color: #667eea; }
    .stat-content { display: flex; flex-direction: column; }
    .stat-label { font-size: 0.85rem; color: #666; }
    .stat-value { font-weight: 600; color: #333; font-size: 1.2rem; }
    
    .quick-actions { display: flex; gap: 10px; padding: 20px; background: #f8f9fa; border-top: 1px solid #eaeaea; }
    
    .no-session-card { background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); padding: 50px 30px; text-align: center; margin-bottom: 30px; }
    .no-session-icon { color: #667eea; margin-bottom: 20px; opacity: 0.7; }
    .no-session-card h3 { margin: 0 0 10px 0; color: #333; }
    .session-tips { text-align: left; max-width: 500px; margin: 30px auto 0 auto; padding: 20px; background: #f8f9fa; border-radius: 8px; }
    .session-tips ul { margin: 10px 0 0 20px; color: #666; }
    
    .sessions-history-card { background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); padding: 25px; }
    .sessions-history-card h3 { margin: 0 0 20px 0; color: #333; display: flex; align-items: center; gap: 10px; }
    
    .table { width: 100%; border-collapse: collapse; }
    .table th { padding: 12px 15px; text-align: left; border-bottom: 2px solid #dee2e6; color: #333; font-weight: 600; background: #f8f9fa; }
    .table td { padding: 15px; border-bottom: 1px solid #eaeaea; }
    .table tr:hover { background: #f8f9fa; }
    
    .session-time { display: flex; flex-direction: column; }
    .session-time .date { font-weight: 500; color: #333; }
    .session-time .time { font-size: 0.85rem; color: #666; }
    
    .duration { font-weight: 500; color: #333; }
    .attendance-count { background: #e3f2fd; color: #1976d2; padding: 5px 12px; border-radius: 20px; font-weight: 500; font-size: 0.9rem; }
    
    .badge-secondary { background: #e2e3e5; color: #383d41; padding: 5px 10px; border-radius: 20px; font-size: 0.85rem; }
    
    .session-actions-small { display: flex; gap: 5px; }
    
    .empty-history { text-align: center; padding: 40px 20px; color: #6c757d; }
    .empty-history i { opacity: 0.5; margin-bottom: 15px; }
    
    .text-muted { color: #6c757d !important; }
    .text-success { color: #42b883 !important; }
    .d-inline { display: inline !important; }
    .mt-3 { margin-top: 15px; }
    .mt-4 { margin-top: 20px; }
</style>

<script>
    // JavaScript with proper error handling
    let sessionStartTime = null;
    let updateInterval = null;
    let attendanceUpdateInterval = null;
    
    function updateSessionTimer() {
        try {
            // Only update timer if we have time remaining data
            const progressBar = document.getElementById('sessionProgressBar');
            const timeRemainingEl = document.getElementById('timeRemaining');
            
            if (!progressBar || !timeRemainingEl) {
                return;
            }
            
            // Get current progress from data attribute
            const currentProgress = parseFloat(progressBar.style.width) || 0;
            
            // If we have progress data, update it
            if (currentProgress < 100) {
                // Increment progress by 1% every minute (approximately)
                const newProgress = Math.min(currentProgress + (1/180), 100); // 180 minutes = 3 hours
                progressBar.style.width = `${newProgress}%`;
                
                // Update time remaining display
                if (newProgress < 100) {
                    const remainingPercent = 100 - newProgress;
                    const remainingMinutes = Math.round((remainingPercent / 100) * 180);
                    
                    if (remainingMinutes > 60) {
                        const hours = Math.floor(remainingMinutes / 60);
                        const minutes = remainingMinutes % 60;
                        timeRemainingEl.innerHTML = `<i class="fas fa-hourglass-half"></i> ${hours}h ${minutes}m remaining`;
                    } else if (remainingMinutes > 0) {
                        timeRemainingEl.innerHTML = `<i class="fas fa-hourglass-half"></i> ${remainingMinutes}m remaining`;
                    } else {
                        timeRemainingEl.innerHTML = `<i class="fas fa-hourglass-half"></i> Less than a minute remaining`;
                        timeRemainingEl.style.color = '#ff6b6b';
                        progressBar.style.background = 'linear-gradient(90deg, #ffa726, #ff6b6b)';
                    }
                } else {
                    timeRemainingEl.innerHTML = `<i class="fas fa-hourglass-end"></i> Session expired`;
                    timeRemainingEl.style.color = '#dc3545';
                    progressBar.style.background = '#dc3545';
                }
            }
                
        } catch (error) {
            console.error('Error in updateSessionTimer:', error);
        }
    }
    
    async function updateAttendanceCount() {
        try {
            const response = await fetch(`/lecturer/courses/{{ course.id }}/live-attendance/poll`);
            if (response.ok) {
                const data = await response.json();
                document.getElementById('attendanceCount').textContent = data.length || 0;
            }
        } catch (error) {
            console.error('Error updating attendance count:', error);
        }
    }
    
    function refreshQR() {
        fetch(`/lecturer/courses/{{ course.id }}/generate-qr`, {
            method: 'POST'
        })
        .then(response => {
            if (response.ok) {
                alert('QR Code refreshed successfully!');
            } else {
                alert('Error refreshing QR code');
            }
        })
        .catch(error => {
            console.error('Error refreshing QR:', error);
            alert('Network error refreshing QR code');
        });
    }
    
    function copySessionLink(sessionId) {
        try {
            navigator.clipboard.writeText(sessionId)
                .then(() => alert('Session ID copied to clipboard!'))
                .catch(() => {
                    // Fallback for older browsers
                    const el = document.createElement('textarea');
                    el.value = sessionId;
                    document.body.appendChild(el);
                    el.select();
                    document.execCommand('copy');
                    document.body.removeChild(el);
                    alert('Session ID copied to clipboard!');
                });
        } catch (error) {
            console.error('Error copying session ID:', error);
        }
    }
    
    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function() {
        {% if active_session %}
        // Start attendance polling
        updateAttendanceCount();
        attendanceUpdateInterval = setInterval(updateAttendanceCount, 10000);
        
        // Start timer updates if we have progress data
        if (document.getElementById('sessionProgressBar')) {
            updateSessionTimer();
            updateInterval = setInterval(updateSessionTimer, 60000); // Update every minute
        }
        {% endif %}
    });
    
    // Clean up
    window.addEventListener('beforeunload', function() {
        if (updateInterval) clearInterval(updateInterval);
        if (attendanceUpdateInterval) clearInterval(attendanceUpdateInterval);
    });
</script>
{% endblock %}
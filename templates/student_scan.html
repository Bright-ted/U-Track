{% extends "base_student.html" %}

{% block title %}Scan QR Code{% endblock %}
{% block page_title %}Scan QR Code{% endblock %}
{% block page_subtitle %}Mark your attendance for today's class{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Mobile-Friendly Instructions -->
    <div class="mobile-instructions alert alert-info d-md-none mb-3">
        <h6><i class="fas fa-mobile-alt"></i> Mobile Instructions:</h6>
        <ul class="mb-0 pl-3">
            <li>Hold your phone steady over the QR code</li>
            <li>Make sure the QR code is within the scanning area</li>
            <li>Enable camera permissions if prompted</li>
        </ul>
    </div>

    <!-- Scan Status -->
    <div class="scan-status-card mb-4">
        <div class="status-header">
            <h3><i class="fas fa-camera"></i> QR Code Scanner</h3>
            <div class="status-badge" id="statusBadge">
                <span class="badge badge-warning">Ready to Scan</span>
            </div>
        </div>
        <div class="status-message" id="statusMessage">
            <p>Point your camera at the lecturer's QR code to mark attendance</p>
        </div>
    </div>

    <!-- Camera and Preview Section -->
    <div class="row">
        <!-- Camera Feed -->
        <div class="col-lg-8 mb-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="fas fa-video"></i> Camera Feed
                    </h4>
                    <div class="camera-actions">
                        <button class="btn btn-sm btn-outline-secondary" id="flipCamera">
                            <i class="fas fa-sync-alt"></i> Flip
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" id="flashToggle" style="display: none;">
                            <i class="fas fa-bolt"></i> Flash
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="camera-container">
                        <div id="cameraView">
                            <div class="camera-placeholder" id="cameraPlaceholder">
                                <div class="placeholder-content">
                                    <i class="fas fa-camera fa-4x mb-3"></i>
                                    <h5>Camera Preview</h5>
                                    <p class="text-muted">Camera will start when you click "Start Camera"</p>
                                    <button class="btn btn-primary" id="startCameraMobile">
                                        <i class="fas fa-play"></i> Start Camera
                                    </button>
                                </div>
                            </div>
                            <video id="cameraFeed" playsinline autoplay style="display: none;"></video>
                            <canvas id="qrCanvas" style="display: none;"></canvas>
                        </div>
                        
                        <!-- QR Code Overlay -->
                        <div class="qr-overlay">
                            <div class="qr-guide"></div>
                            <div class="scan-line" id="scanLine"></div>
                            <div class="scan-hint">
                                <i class="fas fa-info-circle"></i> Align QR code within the box
                            </div>
                        </div>
                        
                        <div class="camera-controls mt-3 p-3">
                            <div class="d-flex flex-wrap gap-2 align-items-center">
                                <button class="btn btn-primary" id="startCamera">
                                    <i class="fas fa-play"></i> Start Camera
                                </button>
                                <button class="btn btn-secondary" id="stopCamera" style="display: none;">
                                    <i class="fas fa-stop"></i> Stop Camera
                                </button>
                                <button class="btn btn-outline-primary" id="toggleCamera">
                                    <i class="fas fa-camera"></i> Switch Camera
                                </button>
                                <button class="btn btn-outline-success" id="uploadQR">
                                    <i class="fas fa-upload"></i> Upload QR Image
                                </button>
                                <input type="file" id="qrFileInput" accept="image/*" capture="environment" style="display: none;">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Scan Results -->
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="fas fa-check-circle"></i> Scan Results
                    </h4>
                </div>
                <div class="card-body d-flex flex-column">
                    <div class="scan-results flex-grow-1" id="scanResults">
                        <div class="empty-results">
                            <i class="fas fa-qrcode fa-3x mb-3"></i>
                            <h5>Ready to Scan</h5>
                            <p class="text-muted">Scan results will appear here</p>
                        </div>
                    </div>
                    
                    <!-- Manual QR Input -->
                    <div class="manual-input mt-4">
                        <h5><i class="fas fa-keyboard"></i> Manual Entry</h5>
                        <p class="text-muted">Enter QR code if camera isn't working</p>
                        <div class="input-group">
                            <input type="text" 
                                   class="form-control" 
                                   id="manualQRInput"
                                   placeholder="Enter QR code here..."
                                   autocomplete="off">
                            <div class="input-group-append">
                                <button class="btn btn-primary" id="manualSubmit">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                        <small class="text-muted d-block mt-2">
                            <i class="fas fa-lightbulb"></i> QR codes are case-sensitive
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Recent Attendance -->
    <div class="card mt-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h4 class="mb-0">
                <i class="fas fa-history"></i> Recent Attendance
            </h4>
            <button class="btn btn-sm btn-outline-secondary" id="refreshAttendance">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>
        <div class="card-body">
            <div class="recent-attendance" id="recentAttendance">
                <div class="loading-spinner">
                    <div class="spinner"></div>
                    <p>Loading attendance history...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-check-circle text-success"></i> Attendance Marked
                </h5>
            </div>
            <div class="modal-body">
                <div class="success-content" id="successContent">
                    <!-- Success content will be inserted here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>

<!-- Error Modal -->
<div class="modal fade" id="errorModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-circle text-danger"></i> Error
                </h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body" id="errorModalBody">
                <!-- Error content will be inserted here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Camera Permission Modal -->
<div class="modal fade" id="cameraPermissionModal" tabindex="-1" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-camera text-info"></i> Camera Permission Required
                </h5>
            </div>
            <div class="modal-body">
                <p>To scan QR codes, you need to allow camera access.</p>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Note for iOS users:</strong> Make sure to:
                    <ul class="mb-0 mt-2">
                        <li>Tap "Allow" when prompted for camera access</li>
                        <li>Check Settings > Safari > Camera if access was denied</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-dismiss="modal" id="requestPermission">
                    Allow Camera Access
                </button>
                <button type="button" class="btn btn-outline-secondary" data-dismiss="modal">
                    Use Manual Entry
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    .container-fluid {
        padding: 0;
    }
    
    /* Mobile-specific styles */
    @media (max-width: 768px) {
        .camera-container {
            height: 70vh !important;
            max-height: 500px;
        }
        
        #cameraView {
            height: calc(100% - 60px) !important;
        }
        
        .qr-guide {
            width: 200px !important;
            height: 200px !important;
        }
        
        .scan-hint {
            font-size: 0.8rem !important;
            padding: 5px 10px !important;
        }
        
        .mobile-instructions {
            display: block !important;
        }
        
        .camera-controls .btn {
            font-size: 0.9rem;
            padding: 8px 12px;
        }
    }
    
    /* Tablet styles */
    @media (max-width: 992px) and (min-width: 769px) {
        .camera-container {
            height: 60vh;
        }
    }
    
    .mobile-instructions {
        border-radius: 10px;
        border-left: 4px solid #17a2b8;
    }
    
    .scan-status-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .status-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        flex-wrap: wrap;
        gap: 10px;
    }
    
    .status-header h3 {
        margin: 0;
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 1.3rem;
    }
    
    .badge-warning {
        background: linear-gradient(135deg, #ffa726 0%, #f57c00 100%);
        color: white;
        padding: 6px 12px;
        border-radius: 20px;
        font-weight: 500;
        font-size: 0.9rem;
    }
    
    .badge-success {
        background: linear-gradient(135deg, #42b883 0%, #347357 100%);
        color: white;
        padding: 6px 12px;
        border-radius: 20px;
        font-weight: 500;
        font-size: 0.9rem;
    }
    
    .badge-danger {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
        color: white;
        padding: 6px 12px;
        border-radius: 20px;
        font-weight: 500;
        font-size: 0.9rem;
    }
    
    .badge-info {
        background: linear-gradient(135deg, #4fc3f7 0%, #0288d1 100%);
        color: white;
        padding: 6px 12px;
        border-radius: 20px;
        font-weight: 500;
        font-size: 0.9rem;
    }
    
    .status-message p {
        margin: 0;
        opacity: 0.9;
        font-size: 0.95rem;
    }
    
    .camera-container {
        position: relative;
        width: 100%;
        background: #000;
        border-radius: 8px;
        overflow: hidden;
        height: 500px;
    }
    
    #cameraView {
        position: relative;
        width: 100%;
        height: calc(100% - 60px);
        display: flex;
        align-items: center;
        justify-content: center;
        background: #000;
    }
    
    .camera-placeholder {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #1a1a1a;
        z-index: 1;
    }
    
    .placeholder-content {
        text-align: center;
        color: #fff;
        padding: 20px;
        max-width: 300px;
    }
    
    .placeholder-content i {
        opacity: 0.5;
        margin-bottom: 15px;
    }
    
    #cameraFeed {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transform: scaleX(1); /* For front/back camera flipping */
    }
    
    .qr-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 2;
    }
    
    .qr-guide {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 250px;
        height: 250px;
        border: 2px dashed rgba(255, 255, 255, 0.5);
        border-radius: 8px;
        background: rgba(0, 0, 0, 0.2);
    }
    
    .qr-guide:before,
    .qr-guide:after,
    .qr-guide-corner-bottom-left,
    .qr-guide-corner-bottom-right {
        content: '';
        position: absolute;
        width: 20px;
        height: 20px;
        border: 3px solid #42b883;
    }
    
    .qr-guide:before {
        top: 0;
        left: 0;
        border-right: none;
        border-bottom: none;
        border-top-left-radius: 4px;
    }
    
    .qr-guide:after {
        top: 0;
        right: 0;
        border-left: none;
        border-bottom: none;
        border-top-right-radius: 4px;
    }
    
    .qr-guide-corner-bottom-left {
        bottom: 0;
        left: 0;
        border-right: none;
        border-top: none;
        border-bottom-left-radius: 4px;
    }
    
    .qr-guide-corner-bottom-right {
        bottom: 0;
        right: 0;
        border-left: none;
        border-top: none;
        border-bottom-right-radius: 4px;
    }
    
    #scanLine {
        position: absolute;
        left: 50%;
        top: 0;
        transform: translateX(-50%);
        width: 250px;
        height: 3px;
        background: linear-gradient(90deg, transparent, #42b883, transparent);
        animation: scan 2s infinite linear;
        box-shadow: 0 0 10px rgba(66, 184, 131, 0.7);
    }
    
    @keyframes scan {
        0% { top: 0; opacity: 0.7; }
        50% { opacity: 1; }
        100% { top: 100%; opacity: 0.7; }
    }
    
    .scan-hint {
        position: absolute;
        bottom: 20px;
        left: 0;
        width: 100%;
        text-align: center;
        color: rgba(255, 255, 255, 0.8);
        font-size: 0.9rem;
        padding: 10px;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
    }
    
    .scan-hint i {
        margin-right: 5px;
    }
    
    .camera-controls {
        background: #f8f9fa;
        border-top: 1px solid #dee2e6;
    }
    
    .camera-controls .btn {
        font-size: 0.9rem;
    }
    
    .camera-actions {
        display: flex;
        gap: 5px;
    }
    
    .camera-actions .btn-sm {
        padding: 3px 8px;
        font-size: 0.8rem;
    }
    
    .scan-results {
        min-height: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .empty-results {
        text-align: center;
        color: #6c757d;
        padding: 30px 0;
    }
    
    .empty-results i {
        opacity: 0.5;
        margin-bottom: 15px;
    }
    
    .recent-attendance {
        min-height: 150px;
    }
    
    .loading-spinner {
        text-align: center;
        padding: 40px 0;
    }
    
    .spinner {
        border: 4px solid rgba(0,0,0,0.1);
        border-left-color: #667eea;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px auto;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .modal-content {
        border: none;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    
    .modal-header {
        border-bottom: 1px solid #eaeaea;
    }
    
    .success-content {
        text-align: center;
        padding: 10px 0;
    }
    
    /* For iOS Safari video fullscreen fix */
    video::-webkit-media-controls {
        display: none !important;
    }
    
    video::-webkit-media-controls-enclosure {
        display: none !important;
    }
    
    video::-webkit-media-controls-panel {
        display: none !important;
    }
    
    /* Touch-friendly buttons for mobile */
    .btn {
        touch-action: manipulation;
    }
    
    /* Better focus states for accessibility */
    .btn:focus {
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3);
    }
</style>

<!-- Include jsQR library -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

<script>
    // Mobile-compatible QR scanner with better error handling
    class QRScanner {
        constructor() {
            this.videoStream = null;
            this.cameraActive = false;
            this.scanningActive = false;
            this.scanInterval = null;
            this.currentSessionId = null;
            this.currentCamera = 'environment'; // 'environment' or 'user'
            this.isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            this.isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
            this.isAndroid = /Android/i.test(navigator.userAgent);
            
            // Initialize elements
            this.initElements();
            this.initEventListeners();
            this.checkPermissions();
        }
        
        initElements() {
            this.cameraFeed = document.getElementById('cameraFeed');
            this.cameraPlaceholder = document.getElementById('cameraPlaceholder');
            this.startCameraBtn = document.getElementById('startCamera');
            this.startCameraMobileBtn = document.getElementById('startCameraMobile');
            this.stopCameraBtn = document.getElementById('stopCamera');
            this.toggleCameraBtn = document.getElementById('toggleCamera');
            this.flipCameraBtn = document.getElementById('flipCamera');
            this.flashToggleBtn = document.getElementById('flashToggle');
            this.uploadQRBtn = document.getElementById('uploadQR');
            this.qrFileInput = document.getElementById('qrFileInput');
            this.scanLine = document.getElementById('scanLine');
            this.statusBadge = document.getElementById('statusBadge');
            this.statusMessage = document.getElementById('statusMessage');
            this.scanResults = document.getElementById('scanResults');
            this.recentAttendance = document.getElementById('recentAttendance');
            this.manualQRInput = document.getElementById('manualQRInput');
            this.manualSubmit = document.getElementById('manualSubmit');
            this.refreshAttendanceBtn = document.getElementById('refreshAttendance');
            this.qrCanvas = document.getElementById('qrCanvas');
            this.canvasContext = this.qrCanvas.getContext('2d', { willReadFrequently: true });
        }
        
        initEventListeners() {
            this.startCameraBtn.addEventListener('click', () => this.startCamera());
            this.startCameraMobileBtn.addEventListener('click', () => this.startCamera());
            this.stopCameraBtn.addEventListener('click', () => this.stopCamera());
            this.toggleCameraBtn.addEventListener('click', () => this.switchCamera());
            this.flipCameraBtn.addEventListener('click', () => this.flipCamera());
            this.uploadQRBtn.addEventListener('click', () => this.qrFileInput.click());
            this.qrFileInput.addEventListener('change', (e) => this.handleImageUpload(e));
            this.manualSubmit.addEventListener('click', () => this.handleManualQR());
            this.manualQRInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') this.handleManualQR();
            });
            this.refreshAttendanceBtn.addEventListener('click', () => this.loadRecentAttendance());
            
            // Handle page visibility changes (for mobile)
            document.addEventListener('visibilitychange', () => {
                if (document.hidden && this.cameraActive) {
                    this.stopCamera();
                }
            });
            
            // Handle page unload
            window.addEventListener('beforeunload', () => this.stopCamera());
            
            // Handle orientation changes for mobile
            window.addEventListener('orientationchange', () => {
                setTimeout(() => {
                    if (this.cameraActive) {
                        this.adjustCameraForOrientation();
                    }
                }, 300);
            });
        }
        
        async checkPermissions() {
            try {
                // Check if we have camera permissions
                const permissionStatus = await navigator.permissions.query({ name: 'camera' });
                
                if (permissionStatus.state === 'granted') {
                    // Permissions already granted
                    this.updateStatus('idle', 'Camera ready. Click "Start Camera" to begin.');
                } else if (permissionStatus.state === 'prompt') {
                    // Will prompt user when they start camera
                    this.updateStatus('idle', 'Ready to scan QR code.');
                } else {
                    // Permission denied
                    this.showCameraPermissionModal();
                }
                
                permissionStatus.onchange = () => {
                    if (permissionStatus.state === 'granted') {
                        this.updateStatus('idle', 'Camera permission granted. Ready to scan.');
                    } else if (permissionStatus.state === 'denied') {
                        this.showCameraPermissionModal();
                    }
                };
            } catch (error) {
                // Permissions API not supported (older browsers)
                console.log('Permissions API not supported');
            }
        }
        
        showCameraPermissionModal() {
            const modal = new bootstrap.Modal(document.getElementById('cameraPermissionModal'));
            modal.show();
            
            document.getElementById('requestPermission').addEventListener('click', () => {
                this.startCamera();
            });
        }
        
        async startCamera() {
            try {
                this.updateStatus('initializing', 'Starting camera...');
                
                // Mobile-specific constraints
                const constraints = {
                    video: {
                        facingMode: this.currentCamera,
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        frameRate: { ideal: 30 }
                    },
                    audio: false
                };
                
                // Adjust for iOS
                if (this.isIOS) {
                    // iOS Safari needs specific settings
                    constraints.video = {
                        facingMode: this.currentCamera,
                        width: { min: 480, ideal: 1280, max: 1920 },
                        height: { min: 320, ideal: 720, max: 1080 },
                        frameRate: { ideal: 24 }
                    };
                }
                
                // Try to get camera stream
                this.videoStream = await navigator.mediaDevices.getUserMedia(constraints);
                
                // Set video source
                this.cameraFeed.srcObject = this.videoStream;
                
                // Wait for video to be ready
                await new Promise((resolve) => {
                    this.cameraFeed.onloadedmetadata = () => {
                        this.cameraFeed.play().then(resolve);
                    };
                });
                
                // Update UI
                this.cameraFeed.style.display = 'block';
                this.cameraPlaceholder.style.display = 'none';
                this.startCameraBtn.style.display = 'none';
                this.startCameraMobileBtn.style.display = 'none';
                this.stopCameraBtn.style.display = 'inline-block';
                this.scanLine.style.display = 'block';
                
                this.cameraActive = true;
                this.updateStatus('ready', 'Camera active. Scan QR code now.');
                
                // Adjust for orientation
                this.adjustCameraForOrientation();
                
                // Start scanning
                this.startScanning();
                
            } catch (error) {
                console.error('Camera error:', error);
                
                if (error.name === 'NotAllowedError') {
                    this.updateStatus('error', 'Camera access denied. Please allow camera access.');
                    this.showErrorModal(
                        'Camera Access Denied',
                        'Please enable camera access in your browser settings and try again.'
                    );
                } else if (error.name === 'NotFoundError') {
                    this.updateStatus('error', 'No camera found.');
                    this.showErrorModal(
                        'No Camera Found',
                        'No camera was found on your device. Please use manual entry or upload an image.'
                    );
                } else if (error.name === 'NotReadableError') {
                    this.updateStatus('error', 'Camera is in use by another application.');
                    this.showErrorModal(
                        'Camera in Use',
                        'Another application is using the camera. Please close it and try again.'
                    );
                } else if (error.name === 'OverconstrainedError') {
                    // Try with simpler constraints
                    this.currentCamera = 'user'; // Try front camera
                    setTimeout(() => this.startCamera(), 100);
                } else {
                    this.updateStatus('error', 'Failed to start camera: ' + error.message);
                    this.showErrorModal(
                        'Camera Error',
                        'Failed to start camera. Please try manual entry.'
                    );
                }
            }
        }
        
        stopCamera() {
            if (this.scanInterval) {
                clearInterval(this.scanInterval);
                this.scanInterval = null;
            }
            
            if (this.videoStream) {
                this.videoStream.getTracks().forEach(track => track.stop());
                this.videoStream = null;
            }
            
            this.cameraFeed.srcObject = null;
            this.cameraFeed.style.display = 'none';
            this.cameraPlaceholder.style.display = 'flex';
            this.startCameraBtn.style.display = 'inline-block';
            this.startCameraMobileBtn.style.display = 'inline-block';
            this.stopCameraBtn.style.display = 'none';
            this.scanLine.style.display = 'none';
            
            this.cameraActive = false;
            this.scanningActive = false;
            this.updateStatus('idle', 'Camera stopped. Ready to start.');
        }
        
        switchCamera() {
            if (!this.cameraActive) return;
            
            this.currentCamera = this.currentCamera === 'environment' ? 'user' : 'environment';
            this.stopCamera();
            setTimeout(() => this.startCamera(), 300);
        }
        
        flipCamera() {
            if (!this.cameraActive) return;
            
            this.cameraFeed.style.transform = this.cameraFeed.style.transform === 'scaleX(-1)' 
                ? 'scaleX(1)' 
                : 'scaleX(-1)';
        }
        
        adjustCameraForOrientation() {
            if (!this.cameraActive) return;
            
            // Get current orientation
            const orientation = window.screen.orientation 
                ? window.screen.orientation.type 
                : window.orientation;
            
            // Adjust camera feed based on orientation
            if (this.isMobile) {
                let transform = '';
                switch(orientation) {
                    case 'landscape-primary':
                    case 90:
                        transform = 'rotate(0deg)';
                        break;
                    case 'landscape-secondary':
                    case -90:
                        transform = 'rotate(180deg)';
                        break;
                    case 'portrait-secondary':
                    case -180:
                        transform = 'rotate(270deg)';
                        break;
                    case 'portrait-primary':
                    default:
                        transform = 'rotate(90deg)';
                        break;
                }
                
                this.cameraFeed.style.transform = transform;
            }
        }
        
        startScanning() {
            if (this.scanningActive) return;
            
            this.scanningActive = true;
            this.updateStatus('scanning', 'Scanning for QR codes...');
            
            this.scanInterval = setInterval(() => {
                if (!this.cameraActive || !this.cameraFeed.videoWidth) return;
                
                // Set canvas dimensions
                this.qrCanvas.width = this.cameraFeed.videoWidth;
                this.qrCanvas.height = this.cameraFeed.videoHeight;
                
                // Draw video frame to canvas
                this.canvasContext.drawImage(
                    this.cameraFeed, 
                    0, 0, 
                    this.qrCanvas.width, 
                    this.qrCanvas.height
                );
                
                // Get image data from center region
                const centerX = this.qrCanvas.width / 2;
                const centerY = this.qrCanvas.height / 2;
                const scanSize = Math.min(300, this.qrCanvas.width, this.qrCanvas.height);
                
                const imageData = this.canvasContext.getImageData(
                    centerX - scanSize/2,
                    centerY - scanSize/2,
                    scanSize,
                    scanSize
                );
                
                // Try to decode QR code
                try {
                    const code = jsQR(imageData.data, scanSize, scanSize, {
                        inversionAttempts: 'dontInvert'
                    });
                    
                    if (code) {
                        console.log('QR code detected:', code.data);
                        this.handleQRCode(code.data);
                    }
                } catch (error) {
                    console.error('QR decoding error:', error);
                }
            }, 300); // Scan every 300ms
        }
        
        async handleQRCode(qrData) {
            // Stop scanning temporarily
            if (this.scanInterval) {
                clearInterval(this.scanInterval);
                this.scanInterval = null;
            }
            
            this.updateStatus('processing', 'Validating QR code...');
            
            // Show scanning feedback
            this.scanResults.innerHTML = `
                <div class="text-center">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="sr-only">Processing...</span>
                    </div>
                    <h6>Processing QR Code...</h6>
                    <p class="text-muted">${qrData.substring(0, 30)}...</p>
                </div>
            `;
            
            try {
                const response = await fetch('/attendance/scan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ qr_seed: qrData.trim() })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Success!
                    this.currentSessionId = result.session_id;
                    this.updateStatus('success', 'Attendance marked successfully!');
                    this.showSuccessModal(result);
                    this.disableCameraForSession();
                    this.loadRecentAttendance();
                } else {
                    // Error
                    this.updateStatus('error', result.error || 'Error marking attendance');
                    this.showErrorModal('Scan Failed', result.error || 'Failed to mark attendance');
                    
                    // Resume scanning after delay
                    setTimeout(() => {
                        if (this.cameraActive && !this.scanInterval) {
                            this.startScanning();
                        }
                    }, 2000);
                }
            } catch (error) {
                console.error('Network error:', error);
                this.updateStatus('error', 'Network error. Please try again.');
                this.showErrorModal('Network Error', 'Please check your internet connection and try again.');
                
                // Resume scanning
                setTimeout(() => {
                    if (this.cameraActive && !this.scanInterval) {
                        this.startScanning();
                    }
                }, 2000);
            }
        }
        
        async handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Reset file input
            event.target.value = '';
            
            if (!file.type.startsWith('image/')) {
                this.showErrorModal('Invalid File', 'Please upload an image file.');
                return;
            }
            
            this.updateStatus('processing', 'Processing uploaded image...');
            
            const img = new Image();
            const reader = new FileReader();
            
            reader.onload = (e) => {
                img.onload = () => {
                    // Draw image to canvas
                    this.qrCanvas.width = img.width;
                    this.qrCanvas.height = img.height;
                    this.canvasContext.drawImage(img, 0, 0);
                    
                    // Try to decode QR code
                    const imageData = this.canvasContext.getImageData(0, 0, img.width, img.height);
                    const code = jsQR(imageData.data, img.width, img.height, {
                        inversionAttempts: 'dontInvert'
                    });
                    
                    if (code) {
                        this.handleQRCode(code.data);
                    } else {
                        this.updateStatus('error', 'No QR code found in image.');
                        this.showErrorModal('No QR Code Found', 'Could not find a valid QR code in the uploaded image.');
                    }
                };
                img.src = e.target.result;
            };
            
            reader.readAsDataURL(file);
        }
        
        handleManualQR() {
            const qrCode = this.manualQRInput.value.trim();
            if (!qrCode) {
                this.showErrorModal('Empty Input', 'Please enter a QR code.');
                return;
            }
            
            if (qrCode.length < 10) {
                this.showErrorModal('Invalid QR Code', 'QR code appears to be too short.');
                return;
            }
            
            this.handleQRCode(qrCode);
            this.manualQRInput.value = '';
        }
        
        updateStatus(status, message) {
            const badge = this.statusBadge.querySelector('.badge');
            badge.className = 'badge';
            
            switch(status) {
                case 'idle':
                    badge.classList.add('badge-warning');
                    badge.textContent = 'Ready to Scan';
                    break;
                case 'initializing':
                    badge.classList.add('badge-info');
                    badge.textContent = 'Initializing';
                    break;
                case 'ready':
                    badge.classList.add('badge-success');
                    badge.textContent = 'Camera Active';
                    break;
                case 'scanning':
                    badge.classList.add('badge-info');
                    badge.textContent = 'Scanning...';
                    break;
                case 'processing':
                    badge.classList.add('badge-primary');
                    badge.textContent = 'Processing';
                    break;
                case 'success':
                    badge.classList.add('badge-success');
                    badge.textContent = 'Success';
                    break;
                case 'error':
                    badge.classList.add('badge-danger');
                    badge.textContent = 'Error';
                    break;
            }
            
            this.statusMessage.innerHTML = `<p>${message}</p>`;
        }
        
        showSuccessModal(result) {
            const modalContent = document.getElementById('successContent');
            modalContent.innerHTML = `
                <div class="success-details">
                    <div class="student-avatar-large mb-3 mx-auto" style="width: 80px; height: 80px;">
                        ${result.photo ? 
                            `<img src="${result.photo}" alt="${result.name}" 
                                  class="rounded-circle w-100 h-100" style="object-fit: cover;">` : 
                            `<div class="rounded-circle w-100 h-100 bg-primary d-flex align-items-center justify-content-center text-white">
                                <i class="fas fa-user fa-2x"></i>
                            </div>`}
                    </div>
                    <h4 class="text-success">Attendance Confirmed!</h4>
                    <div class="alert alert-success mt-3">
                        <i class="fas fa-check-circle"></i>
                        Your attendance has been recorded successfully.
                    </div>
                    <hr>
                    <div class="text-left">
                        <p><strong>Name:</strong> ${result.name}</p>
                        <p><strong>Index Number:</strong> ${result.index_number}</p>
                        <p><strong>Time:</strong> ${new Date().toLocaleTimeString()}</p>
                        ${result.message ? `<p><strong>Note:</strong> ${result.message}</p>` : ''}
                    </div>
                </div>
            `;
            
            const modal = new bootstrap.Modal(document.getElementById('successModal'));
            modal.show();
        }
        
        showErrorModal(title, message) {
            const modalBody = document.getElementById('errorModalBody');
            modalBody.innerHTML = `
                <h6 class="text-danger">${title}</h6>
                <p>${message}</p>
                ${this.isIOS ? `
                    <div class="alert alert-warning mt-3">
                        <i class="fas fa-info-circle"></i>
                        <strong>iOS Tip:</strong> Make sure Safari has camera access in Settings > Safari > Camera
                    </div>
                ` : ''}
            `;
            
            const modal = new bootstrap.Modal(document.getElementById('errorModal'));
            modal.show();
        }
        
        disableCameraForSession() {
            this.stopCamera();
            this.updateStatus('success', 'Attendance already marked for this session.');
            
            this.scanResults.innerHTML = `
                <div class="text-center">
                    <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                    <h5>Attendance Already Marked</h5>
                    <p class="text-muted">You have already marked attendance for this class session.</p>
                    ${this.currentSessionId ? 
                        `<p><small>Session ID: <code>${this.currentSessionId}</code></small></p>` : ''}
                    <button class="btn btn-outline-primary mt-2" onclick="scanner.startCamera()">
                        <i class="fas fa-redo"></i> Scan Again
                    </button>
                </div>
            `;
            
            this.manualQRInput.disabled = true;
            this.manualSubmit.disabled = true;
        }
        
        async loadRecentAttendance() {
            try {
                this.recentAttendance.innerHTML = `
                    <div class="text-center">
                        <div class="spinner-border text-primary mb-3" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                        <p>Loading...</p>
                    </div>
                `;
                
                const response = await fetch('/student/attendance/recent');
                const records = await response.json();
                
                if (records.length === 0) {
                    this.recentAttendance.innerHTML = `
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-calendar-times fa-3x mb-3"></i>
                            <p>No recent attendance records found.</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '<div class="recent-list">';
                records.forEach(record => {
                    const time = new Date(record.scanned_at).toLocaleString();
                    const course = record.class_sessions?.courses;
                    html += `
                        <div class="recent-item">
                            <div class="recent-course">
                                <strong>${course?.course_code || 'Unknown Course'}</strong>
                                <span class="badge ${record.status === 'present' ? 'badge-success' : 'badge-warning'}">
                                    ${record.status}
                                </span>
                            </div>
                            <div class="recent-time">
                                <small class="text-muted">${time}</small>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                this.recentAttendance.innerHTML = html;
            } catch (error) {
                console.error('Error loading recent attendance:', error);
                this.recentAttendance.innerHTML = `
                    <div class="text-center text-danger py-4">
                        <i class="fas fa-exclamation-circle fa-3x mb-3"></i>
                        <p>Failed to load attendance history.</p>
                        <button class="btn btn-sm btn-outline-secondary" onclick="scanner.loadRecentAttendance()">
                            <i class="fas fa-redo"></i> Try Again
                        </button>
                    </div>
                `;
            }
        }
    }
    
    // Initialize scanner when page loads
    let scanner;
    document.addEventListener('DOMContentLoaded', function() {
        scanner = new QRScanner();
        scanner.loadRecentAttendance();
        
        // Auto-start camera for Android devices (if permission already granted)
        if (scanner.isAndroid) {
            setTimeout(() => {
                navigator.permissions.query({ name: 'camera' })
                    .then(permissionStatus => {
                        if (permissionStatus.state === 'granted') {
                            scanner.startCamera();
                        }
                    })
                    .catch(() => {
                        // Permissions API not available
                    });
            }, 500);
        }
    });
</script>
{% endblock %}
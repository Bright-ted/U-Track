{% extends "base_student.html" %}

{% block title %}Scan QR Code{% endblock %}
{% block page_title %}Scan QR Code{% endblock %}
{% block page_subtitle %}Mark your attendance for today's class{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Scan Status -->
    <div class="scan-status-card mb-4">
        <div class="status-header">
            <h3><i class="fas fa-camera"></i> QR Code Scanner</h3>
            <div class="status-badge" id="statusBadge">
                <span class="badge badge-warning">Ready to Scan</span>
            </div>
        </div>
        <div class="status-message" id="statusMessage">
            <p>Point your camera at the lecturer's QR code to mark attendance</p>
        </div>
    </div>

    <!-- Camera and Preview Section -->
    <div class="row">
        <!-- Camera Feed -->
        <div class="col-lg-8 mb-4">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="fas fa-video"></i> Camera Feed
                    </h4>
                </div>
                <div class="card-body">
                    <div class="camera-container">
                        <div id="cameraView">
                            <div class="camera-placeholder" id="cameraPlaceholder">
                                <i class="fas fa-camera fa-4x"></i>
                                <p>Click "Start Camera" to begin scanning</p>
                            </div>
                            <video id="cameraFeed" playsinline style="display: none;"></video>
                            <canvas id="qrCanvas" style="display: none;"></canvas>
                        </div>
                        
                        <!-- QR Code Overlay -->
                        <div class="qr-overlay">
                            <div class="qr-guide"></div>
                            <div class="scan-line" id="scanLine"></div>
                        </div>
                        
                        <div class="camera-controls mt-3">
                            <button class="btn btn-primary" id="startCamera">
                                <i class="fas fa-play"></i> Start Camera
                            </button>
                            <button class="btn btn-secondary" id="stopCamera" style="display: none;">
                                <i class="fas fa-stop"></i> Stop Camera
                            </button>
                            <select class="form-control" id="cameraSelect" style="display: none;">
                                <option value="">Select Camera...</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Scan Results -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="fas fa-check-circle"></i> Scan Results
                    </h4>
                </div>
                <div class="card-body">
                    <div class="scan-results" id="scanResults">
                        <div class="empty-results">
                            <i class="fas fa-qrcode fa-3x"></i>
                            <p>Scan results will appear here</p>
                        </div>
                    </div>
                    
                    <!-- Manual QR Input -->
                    <div class="manual-input mt-4">
                        <h5><i class="fas fa-keyboard"></i> Manual Entry</h5>
                        <p class="text-muted">Enter QR code if camera isn't working</p>
                        <div class="input-group">
                            <input type="text" 
                                   class="form-control" 
                                   id="manualQRInput"
                                   placeholder="Enter QR code here...">
                            <div class="input-group-append">
                                <button class="btn btn-primary" id="manualSubmit">
                                    <i class="fas fa-paper-plane"></i> Submit
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Recent Attendance -->
    <div class="card mt-4">
        <div class="card-header">
            <h4 class="mb-0">
                <i class="fas fa-history"></i> Recent Attendance
            </h4>
        </div>
        <div class="card-body">
            <div class="recent-attendance" id="recentAttendance">
                <div class="loading-spinner">
                    <div class="spinner"></div>
                    <p>Loading attendance history...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-check-circle text-success"></i> Attendance Marked
                </h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="success-content" id="successContent">
                    <!-- Success content will be inserted here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>

<style>
    .container-fluid {
        padding: 0;
    }
    
    .scan-status-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .status-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }
    
    .status-header h3 {
        margin: 0;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .badge-warning {
        background: linear-gradient(135deg, #ffa726 0%, #f57c00 100%);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 500;
    }
    
    .badge-success {
        background: linear-gradient(135deg, #42b883 0%, #347357 100%);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 500;
    }
    
    .badge-danger {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 500;
    }
    
    .badge-info {
        background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 500;
    }
    
    .status-message p {
        margin: 0;
        opacity: 0.9;
    }
    
    .camera-container {
        position: relative;
        width: 100%;
        background: #000;
        border-radius: 8px;
        overflow: hidden;
    }
    
    #cameraView {
        position: relative;
        width: 100%;
        height: 400px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .camera-placeholder {
        text-align: center;
        color: #fff;
        padding: 20px;
    }
    
    .camera-placeholder i {
        opacity: 0.5;
        margin-bottom: 15px;
    }
    
    #cameraFeed {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .qr-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
    }
    
    .qr-guide {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 250px;
        height: 250px;
        border: 2px solid rgba(255, 255, 255, 0.7);
        border-radius: 8px;
    }
    
    .qr-guide:before,
    .qr-guide:after {
        content: '';
        position: absolute;
        width: 30px;
        height: 30px;
        border: 3px solid #42b883;
    }
    
    .qr-guide:before {
        top: 0;
        left: 0;
        border-right: none;
        border-bottom: none;
        border-top-left-radius: 8px;
    }
    
    .qr-guide:after {
        top: 0;
        right: 0;
        border-left: none;
        border-bottom: none;
        border-top-right-radius: 8px;
    }
    
    #scanLine {
        position: absolute;
        left: 50%;
        top: 0;
        transform: translateX(-50%);
        width: 250px;
        height: 3px;
        background: linear-gradient(90deg, transparent, #42b883, transparent);
        animation: scan 2s infinite linear;
        display: none;
    }
    
    @keyframes scan {
        0% { top: 0; }
        100% { top: 100%; }
    }
    
    .camera-controls {
        display: flex;
        gap: 10px;
        align-items: center;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 0 0 8px 8px;
    }
    
    .form-control {
        flex: 1;
    }
    
    .scan-results {
        min-height: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .empty-results {
        text-align: center;
        color: #6c757d;
    }
    
    .empty-results i {
        opacity: 0.5;
        margin-bottom: 15px;
    }
    
    .recent-attendance {
        min-height: 150px;
    }
    
    .loading-spinner {
        text-align: center;
        padding: 40px 0;
    }
    
    .spinner {
        border: 4px solid rgba(0,0,0,0.1);
        border-left-color: #667eea;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px auto;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .modal-content {
        border: none;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    
    .modal-header {
        border-bottom: 1px solid #eaeaea;
    }
    
    .success-content {
        text-align: center;
        padding: 20px 0;
    }
    
    .already-attended {
        text-align: center;
        padding: 30px 0;
    }
    
    .student-avatar-large {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        margin: 0 auto;
        overflow: hidden;
    }
    
    .avatar-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .recent-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    
    .recent-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 15px;
        background: #f8f9fa;
        border-radius: 8px;
        border-left: 3px solid #42b883;
    }
    
    .recent-course {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .no-attendance {
        text-align: center;
        padding: 40px 0;
        color: #6c757d;
    }
    
    .alert-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
        padding: 12px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
</style>

<!-- Include jsQR library for QR code scanning -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

<script>
    let videoStream = null;
    let cameraActive = false;
    let scanningActive = false;
    let scanInterval = null;
    
    // HTML elements
    const cameraFeed = document.getElementById('cameraFeed');
    const cameraPlaceholder = document.getElementById('cameraPlaceholder');
    const startCameraBtn = document.getElementById('startCamera');
    const stopCameraBtn = document.getElementById('stopCamera');
    const cameraSelect = document.getElementById('cameraSelect');
    const scanLine = document.getElementById('scanLine');
    const statusBadge = document.getElementById('statusBadge');
    const statusMessage = document.getElementById('statusMessage');
    const scanResults = document.getElementById('scanResults');
    const recentAttendance = document.getElementById('recentAttendance');
    const manualQRInput = document.getElementById('manualQRInput');
    const manualSubmit = document.getElementById('manualSubmit');
    const qrCanvas = document.getElementById('qrCanvas');
    
    async function getCameraDevices() {
        try {
            const devices = await navigator.mediaDevices.enumerateDevices();
            const videoDevices = devices.filter(device => device.kind === 'videoinput');
            
            cameraSelect.innerHTML = '<option value="">Select Camera...</option>';
            videoDevices.forEach(device => {
                const option = document.createElement('option');
                option.value = device.deviceId;
                option.text = device.label || `Camera ${cameraSelect.options.length}`;
                cameraSelect.appendChild(option);
            });
            
            if (videoDevices.length > 0) {
                cameraSelect.style.display = 'inline-block';
            }
        } catch (error) {
            console.error('Error getting camera devices:', error);
        }
    }
    
    async function startCamera(deviceId = null) {
        try {
            const constraints = {
                video: {
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                },
                audio: false
            };
            
            if (deviceId) {
                constraints.video.deviceId = { exact: deviceId };
            } else {
                // Try to use back camera first
                constraints.video.facingMode = { ideal: 'environment' };
            }
            
            videoStream = await navigator.mediaDevices.getUserMedia(constraints);
            cameraFeed.srcObject = videoStream;
            
            await cameraFeed.play();
            
            cameraFeed.style.display = 'block';
            cameraPlaceholder.style.display = 'none';
            startCameraBtn.style.display = 'none';
            stopCameraBtn.style.display = 'inline-block';
            scanLine.style.display = 'block';
            
            cameraActive = true;
            updateStatus('ready', 'Camera active. Scan QR code now.');
            
            // Start scanning
            startScanning();
            
        } catch (error) {
            console.error('Error starting camera:', error);
            
            if (error.name === 'NotAllowedError') {
                updateStatus('error', 'Camera access denied. Please allow camera permissions.');
                statusMessage.innerHTML = `
                    <p>Camera access denied. Please allow camera access in your browser settings.</p>
                    <p>You can still enter the QR code manually below.</p>
                `;
            } else if (error.name === 'NotFoundError') {
                updateStatus('error', 'No camera found on your device.');
                statusMessage.innerHTML = `
                    <p>No camera found on your device.</p>
                    <p>Please use the manual entry option below.</p>
                `;
            } else if (error.name === 'NotReadableError') {
                updateStatus('error', 'Camera is already in use by another application.');
            } else {
                updateStatus('error', 'Could not access camera. Please check permissions.');
            }
        }
    }
    
    function stopCamera() {
        if (videoStream) {
            videoStream.getTracks().forEach(track => track.stop());
            videoStream = null;
        }
        
        cameraFeed.srcObject = null;
        cameraFeed.style.display = 'none';
        cameraPlaceholder.style.display = 'flex';
        startCameraBtn.style.display = 'inline-block';
        stopCameraBtn.style.display = 'none';
        scanLine.style.display = 'none';
        
        cameraActive = false;
        stopScanning();
        updateStatus('idle', 'Camera stopped. Ready to start.');
    }
    
    function startScanning() {
        if (scanningActive) return;
        
        scanningActive = true;
        scanInterval = setInterval(() => {
            if (!cameraActive || !cameraFeed.videoWidth || cameraFeed.videoWidth === 0) return;
            
            // Set canvas dimensions to match video
            qrCanvas.width = cameraFeed.videoWidth;
            qrCanvas.height = cameraFeed.videoHeight;
            
            const context = qrCanvas.getContext('2d');
            
            // Draw video frame to canvas
            context.drawImage(cameraFeed, 0, 0, qrCanvas.width, qrCanvas.height);
            
            // Get image data from center region (where QR guide is)
            const centerX = qrCanvas.width / 2;
            const centerY = qrCanvas.height / 2;
            const scanSize = Math.min(250, qrCanvas.width * 0.6, qrCanvas.height * 0.6);
            
            const imageData = context.getImageData(
                centerX - scanSize/2,
                centerY - scanSize/2,
                scanSize,
                scanSize
            );
            
            // Try to decode QR code
            try {
                const code = jsQR(imageData.data, scanSize, scanSize, {
                    inversionAttempts: 'dontInvert',
                });
                
                if (code) {
                    // QR code found!
                    handleQRCode(code.data);
                }
            } catch (error) {
                console.log('QR scan error:', error);
            }
        }, 300); // Check every 300ms
    }
    
    function stopScanning() {
        if (scanInterval) {
            clearInterval(scanInterval);
            scanInterval = null;
        }
        scanningActive = false;
    }
    
    function handleQRCode(qrData) {
        // Stop scanning to prevent multiple submissions
        stopScanning();
        updateStatus('scanning', 'QR code detected. Processing...');
        
        // Extract just the QR seed if it's in a URL format
        let qrSeed = qrData;
        
        // If QR contains URL, extract the seed
        if (qrData.includes('ATTENDANCE:')) {
            const parts = qrData.split(':');
            if (parts.length >= 2) {
                qrSeed = parts[1]; // Extract the seed part
            }
        }
        
        // Send QR code to server
        submitQRCode(qrSeed);
    }
    
    async function submitQRCode(qrSeed) {
        try {
            const response = await fetch('/attendance/scan', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ qr_seed: qrSeed })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const result = await response.json();
            
            if (result.success) {
                // Success!
                updateStatus('success', 'Attendance marked successfully!');
                showSuccessModal(result);
                stopCamera(); // Stop camera after successful scan
                loadRecentAttendance();
            } else {
                // Error from server
                updateStatus('error', result.error || result.message || 'Error marking attendance');
                
                // Show detailed error in results
                showErrorInResults(result.error || 'Unknown error');
                
                // Resume scanning after delay
                setTimeout(() => {
                    if (cameraActive) startScanning();
                }, 3000);
            }
        } catch (error) {
            console.error('Error submitting QR code:', error);
            updateStatus('error', 'Network error. Please try again.');
            showErrorInResults('Network error: ' + error.message);
            
            // Resume scanning after delay
            setTimeout(() => {
                if (cameraActive) startScanning();
            }, 3000);
        }
    }
    
    function showErrorInResults(error) {
        scanResults.innerHTML = `
            <div class="error-results">
                <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                <h5>Error Scanning QR Code</h5>
                <p class="text-danger">${error}</p>
                <p class="text-muted">Please try again or enter the code manually.</p>
            </div>
        `;
    }
    
    function updateStatus(status, message) {
        const badge = statusBadge.querySelector('.badge');
        badge.className = 'badge';
        
        switch(status) {
            case 'idle':
                badge.classList.add('badge-warning');
                badge.textContent = 'Ready to Scan';
                break;
            case 'ready':
                badge.classList.add('badge-success');
                badge.textContent = 'Camera Active';
                break;
            case 'scanning':
                badge.classList.add('badge-info');
                badge.textContent = 'Processing QR...';
                break;
            case 'success':
                badge.classList.add('badge-success');
                badge.textContent = 'Attendance Marked';
                break;
            case 'error':
                badge.classList.add('badge-danger');
                badge.textContent = 'Error';
                break;
        }
        
        statusMessage.innerHTML = `<p>${message}</p>`;
    }
    
    function showSuccessModal(result) {
        const modalContent = document.getElementById('successContent');
        modalContent.innerHTML = `
            <div class="success-details">
                <div class="student-avatar-large mb-3">
                    ${result.photo ? 
                        `<img src="${result.photo}" alt="${result.name}" class="avatar-img">` : 
                        `<i class="fas fa-user"></i>`}
                </div>
                <h4>Attendance Confirmed!</h4>
                <p>Name: <strong>${result.name || 'Student'}</strong></p>
                <p>Index: <strong>${result.index_number || 'N/A'}</strong></p>
                <p>Status: <span class="badge badge-success">${result.status || 'present'}</span></p>
                <p>Time: <strong>${new Date().toLocaleTimeString()}</strong></p>
                <div class="alert alert-success mt-3">
                    <i class="fas fa-check-circle"></i>
                    ${result.message || 'Your attendance has been recorded successfully.'}
                </div>
            </div>
        `;
        
        $('#successModal').modal('show');
        
        // Update scan results
        scanResults.innerHTML = `
            <div class="success-results">
                <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                <h5>Attendance Recorded</h5>
                <p><strong>Course:</strong> ${result.course_id ? 'Course ' + result.course_id : 'Not specified'}</p>
                <p><strong>Time:</strong> ${new Date().toLocaleString()}</p>
            </div>
        `;
    }
    
    async function loadRecentAttendance() {
        try {
            const response = await fetch('/student/attendance/recent');
            if (!response.ok) {
                throw new Error('Failed to load recent attendance');
            }
            
            const records = await response.json();
            
            if (!records || records.length === 0) {
                recentAttendance.innerHTML = `
                    <div class="no-attendance">
                        <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                        <p>No recent attendance records found.</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="recent-list">';
            records.forEach(record => {
                const time = new Date(record.scanned_at).toLocaleString();
                const courseCode = record.class_sessions?.courses?.course_code || 'Unknown Course';
                html += `
                    <div class="recent-item">
                        <div class="recent-course">
                            <strong>${courseCode}</strong>
                            <span class="badge ${record.status === 'present' ? 'badge-success' : 'badge-warning'}">
                                ${record.status || 'unknown'}
                            </span>
                        </div>
                        <div class="recent-time">
                            <small class="text-muted">${time}</small>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            recentAttendance.innerHTML = html;
        } catch (error) {
            console.error('Error loading recent attendance:', error);
            recentAttendance.innerHTML = `
                <div class="error-attendance">
                    <i class="fas fa-exclamation-triangle text-warning"></i>
                    <p>Could not load attendance history.</p>
                </div>
            `;
        }
    }
    
    // Event Listeners
    startCameraBtn.addEventListener('click', () => startCamera());
    stopCameraBtn.addEventListener('click', stopCamera);
    
    cameraSelect.addEventListener('change', (e) => {
        if (e.target.value) {
            stopCamera();
            startCamera(e.target.value);
        }
    });
    
    manualSubmit.addEventListener('click', () => {
        const qrCode = manualQRInput.value.trim();
        if (qrCode) {
            handleQRCode(qrCode);
            manualQRInput.value = '';
        }
    });
    
    manualQRInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            manualSubmit.click();
        }
    });
    
    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        // Get available cameras
        getCameraDevices();
        
        // Load recent attendance
        loadRecentAttendance();
        
        // Check for existing camera permissions
        if (navigator.permissions && navigator.permissions.query) {
            navigator.permissions.query({ name: 'camera' })
                .then(permissionStatus => {
                    if (permissionStatus.state === 'granted') {
                        // Camera already granted, we can start automatically
                        updateStatus('ready', 'Camera permission granted. Click Start Camera to begin.');
                    }
                });
        }
    });
    
    // Clean up when leaving page
    window.addEventListener('beforeunload', function() {
        stopCamera();
    });
    
    // Also clean up when page is hidden
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            stopCamera();
        }
    });
</script>
{% endblock %}